# yara_rules/usb_malware.yar
rule USB_Autorun_Malware {
    meta:
        description = "Detects common USB autorun malware"
        author = "USBShield"
        severity = "high"
        reference = "https://example.com/usb-malware"
    
    strings:
        $autorun = "autorun.inf" nocase wide ascii
        $cmd1 = "cmd.exe" nocase wide ascii
        $cmd2 = "cmd /c" nocase wide ascii
        $shell1 = "shell\\open\\command" nocase wide ascii
        $shell2 = "shell\\explore\\command" nocase wide ascii
        $suspicious1 = "Hidden" nocase wide ascii
        $suspicious2 = ".vbs" nocase wide ascii
        $suspicious3 = ".scr" nocase wide ascii
        $reg1 = "RegWrite" nocase wide ascii
        $reg2 = "HKEY_" nocase wide ascii
    
    condition:
        $autorun and (1 of ($cmd*) or 1 of ($shell*)) and (1 of ($suspicious*) or 1 of ($reg*))
}

rule BadUSB_HID_Attack {
    meta:
        description = "Detects potential BadUSB or Rubber Ducky attack scripts"
        author = "USBShield"
        severity = "critical"
        reference = "https://example.com/badusb-attack"
    
    strings:
        $duck1 = "DELAY" nocase
        $duck2 = "STRING" nocase
        $duck3 = "ENTER" nocase
        $duck4 = "GUI r" nocase
        $duck5 = "REM " nocase
        
        $ps1 = "powershell" nocase wide ascii
        $ps2 = "-ExecutionPolicy Bypass" nocase wide ascii
        $ps3 = "Invoke-Expression" nocase wide ascii
        $ps4 = "IEX" nocase
        
        $keylog1 = "keylog" nocase wide ascii
        $keylog2 = "GetAsyncKeyState" nocase wide ascii
        $keylog3 = "SetWindowsHookEx" nocase wide ascii
        
        $cmd1 = "cmd.exe /c" nocase wide ascii
        $cmd2 = "bitsadmin" nocase wide ascii
        $cmd3 = "certutil -urlcache" nocase wide ascii
    
    condition:
        (2 of ($duck*) and (1 of ($ps*) or 1 of ($cmd*))) or
        (2 of ($ps*) and 1 of ($cmd*)) or
        (1 of ($keylog*) and (1 of ($ps*) or 1 of ($cmd*)))
}

rule Generic_USB_Trojan {
    meta:
        description = "Detects generic trojan patterns often found on USB drives"
        author = "USBShield"
        severity = "high"
        reference = "https://example.com/usb-trojans"
    
    strings:
        $str1 = "GetWindowsDirectory" ascii
        $str2 = "GetSystemDirectory" ascii
        $str3 = "CreateRemoteThread" ascii
        $str4 = "WriteProcessMemory" ascii
        $str5 = "CreateProcess" ascii
        $str6 = "TEMPORARY DIRECTORY" nocase ascii
        $str7 = "RECYCLER" nocase ascii
        $str8 = "cmd.exe /c" nocase ascii
        $str9 = "explorer.exe" nocase ascii
        $str10 = "System32" nocase ascii
        $str11 = "regsvr32" nocase ascii
        $str12 = ".dll" nocase ascii
        $str13 = ".exe" nocase ascii
        $str14 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii
        
    condition:
        5 of them
}